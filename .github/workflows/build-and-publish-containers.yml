name: Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'emf-gateway/**'
      - 'emf-platform/runtime/**'
      - 'emf-worker/**'
      - 'emf-web/**'
      - 'emf-ui/**'
      - '.github/workflows/build-and-publish-containers.yml'
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to DockerHub'
        required: false
        default: 'true'
        type: boolean
      deploy:
        description: 'Update ArgoCD manifests to trigger deployment'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: build-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKERHUB_USERNAME: cklinker
  JAVA_VERSION: '21'
  NODE_VERSION: '18'
  MAVEN_VERSION: '3.9.9'
  # Override MAVEN_OPTS from runner env to use default ~/.m2/repository
  MAVEN_OPTS: ''

jobs:
  # ===========================================================================
  # Build runtime + test all Java services in a single job
  # ===========================================================================
  test-java:
    name: Build & Test Java
    runs-on: k8s-runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Install Maven
        run: |
          if ! command -v mvn &> /dev/null; then
            curl -fsSL https://archive.apache.org/dist/maven/maven-3/${{ env.MAVEN_VERSION }}/binaries/apache-maven-${{ env.MAVEN_VERSION }}-bin.tar.gz | tar xz -C /opt
            echo "/opt/apache-maven-${{ env.MAVEN_VERSION }}/bin" >> $GITHUB_PATH
          fi

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Clean stale EMF artifacts
        run: rm -rf ~/.m2/repository/com/emf

      - name: Build runtime modules
        run: mvn clean install -DskipTests -f emf-platform/pom.xml -pl runtime/runtime-core,runtime/runtime-events,runtime/runtime-jsonapi,runtime/runtime-module-core,runtime/runtime-module-integration,runtime/runtime-module-schema -am -B

      - name: Test Gateway
        run: mvn verify -f emf-gateway/pom.xml -B

      - name: Test Worker
        run: mvn verify -f emf-worker/pom.xml -B

  # ===========================================================================
  # Test Frontend
  # ===========================================================================
  test-frontend:
    name: Test Frontend
    runs-on: k8s-runner
    defaults:
      run:
        working-directory: emf-web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('emf-web/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm install --no-audit --no-fund
        timeout-minutes: 5

      - name: Run tests
        run: npm run test

  # ===========================================================================
  # Build and Push Container Images
  # All services built in a single job to avoid repeated checkouts and
  # Docker Buildx setup across multiple K8s pods.
  # ===========================================================================
  build-and-push:
    name: Build & Push Images
    needs: [test-java, test-frontend]
    runs-on: k8s-runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        if: github.event_name != 'workflow_dispatch' || inputs.push_images
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      # --- Gateway ---
      - name: Build and push Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: emf-gateway/Dockerfile
          push: ${{ github.event_name != 'workflow_dispatch' || inputs.push_images }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/emf-gateway:latest
            ${{ env.DOCKERHUB_USERNAME }}/emf-gateway:main-${{ steps.sha.outputs.short }}
          cache-from: type=gha,scope=gateway
          cache-to: type=gha,mode=max,scope=gateway
          platforms: linux/amd64

      # --- Worker ---
      - name: Build and push Worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: emf-worker/Dockerfile
          push: ${{ github.event_name != 'workflow_dispatch' || inputs.push_images }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/emf-worker:latest
            ${{ env.DOCKERHUB_USERNAME }}/emf-worker:main-${{ steps.sha.outputs.short }}
          cache-from: type=gha,scope=worker
          cache-to: type=gha,mode=max,scope=worker
          platforms: linux/amd64

      # --- Admin UI ---
      - name: Build and push Admin UI
        uses: docker/build-push-action@v5
        with:
          context: .
          file: emf-ui/Dockerfile
          push: ${{ github.event_name != 'workflow_dispatch' || inputs.push_images }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/emf-ui:latest
            ${{ env.DOCKERHUB_USERNAME }}/emf-ui:main-${{ steps.sha.outputs.short }}
          cache-from: type=gha,scope=ui
          cache-to: type=gha,mode=max,scope=ui
          platforms: linux/amd64

  # ===========================================================================
  # Update ArgoCD manifests to trigger deployment
  # ===========================================================================
  deploy:
    name: Update ArgoCD Manifests
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main' && (github.event_name != 'workflow_dispatch' || inputs.deploy)
    runs-on: k8s-runner
    steps:
      - name: Checkout ArgoCD repo
        uses: actions/checkout@v4
        with:
          repository: cklinker/homelab-argo
          token: ${{ secrets.ARGOCD_REPO_TOKEN }}
          path: homelab-argo

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Update image tags
        working-directory: homelab-argo
        run: |
          IMAGE_TAG="main-${{ steps.sha.outputs.short }}"

          # Update gateway deployment
          if [ -f emf/gateway-deployment.yaml ]; then
            sed -i "s|image: cklinker/emf-gateway:.*|image: cklinker/emf-gateway:${IMAGE_TAG}|g" emf/gateway-deployment.yaml
          fi

          # Update admin UI deployment
          if [ -f emf/ui-deployment.yaml ]; then
            sed -i "s|image: cklinker/emf-ui:.*|image: cklinker/emf-ui:${IMAGE_TAG}|g" emf/ui-deployment.yaml
          fi

          # Update worker deployment
          if [ -f emf/worker-deployment.yaml ]; then
            sed -i "s|image: cklinker/emf-worker:.*|image: cklinker/emf-worker:${IMAGE_TAG}|g" emf/worker-deployment.yaml
          fi

      - name: Commit and push
        working-directory: homelab-argo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update EMF images to main-${{ steps.sha.outputs.short }}"
            git push
          fi

  # ===========================================================================
  # Smoke tests on k8s runner (post-deployment verification)
  # ===========================================================================
  smoke-test:
    name: Smoke Test
    needs: deploy
    runs-on: k8s-runner
    timeout-minutes: 10
    steps:
      - name: Wait for rollout
        run: |
          echo "Waiting for deployments to roll out..."
          kubectl -n emf rollout status deployment/emf-gateway --timeout=300s || true
          kubectl -n emf rollout status deployment/emf-ui --timeout=300s || true
          kubectl -n emf rollout status deployment/emf-worker --timeout=300s || true

      - name: Verify gateway health
        run: |
          for i in $(seq 1 30); do
            STATUS=$(kubectl -n emf exec deploy/emf-gateway -- curl -sf http://localhost:8080/actuator/health/liveness 2>/dev/null | grep -o '"status":"UP"' || true)
            if [ -n "$STATUS" ]; then
              echo "Gateway is healthy"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done
          echo "Gateway health check failed"
          exit 1

      - name: Verify worker health
        run: |
          for i in $(seq 1 30); do
            STATUS=$(kubectl -n emf exec deploy/emf-worker -- curl -sf http://localhost:8080/actuator/health/liveness 2>/dev/null | grep -o '"status":"UP"' || true)
            if [ -n "$STATUS" ]; then
              echo "Worker is healthy"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done
          echo "Worker health check failed"
          exit 1
