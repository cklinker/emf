name: CI

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '18'
  MAVEN_VERSION: '3.9.9'
  # Override MAVEN_OPTS from runner env to use default ~/.m2/repository
  MAVEN_OPTS: ''

jobs:
  # ===========================================================================
  # Build runtime + test all Java services in a single job
  # Eliminates 4 separate pod launches, 4 JDK downloads, artifact upload/download
  # ===========================================================================
  test-java:
    name: Build & Test Java
    runs-on: k8s-runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Install Maven
        run: |
          if ! command -v mvn &> /dev/null; then
            curl -fsSL https://archive.apache.org/dist/maven/maven-3/${{ env.MAVEN_VERSION }}/binaries/apache-maven-${{ env.MAVEN_VERSION }}-bin.tar.gz | tar xz -C /opt
            echo "/opt/apache-maven-${{ env.MAVEN_VERSION }}/bin" >> $GITHUB_PATH
          fi

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Clean stale EMF artifacts
        run: rm -rf ~/.m2/repository/com/emf

      - name: Build runtime modules
        run: mvn clean install -DskipTests -f emf-platform/pom.xml -pl runtime/runtime-core,runtime/runtime-events,runtime/runtime-jsonapi,runtime/runtime-module-core,runtime/runtime-module-integration,runtime/runtime-module-schema -am -B

      - name: Test Gateway
        run: mvn verify -f emf-gateway/pom.xml -B

      - name: Test Worker
        run: mvn verify -f emf-worker/pom.xml -B

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-test-results
          path: |
            emf-gateway/target/surefire-reports/
            emf-worker/target/surefire-reports/
          retention-days: 7

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-coverage
          path: |
            emf-gateway/target/site/jacoco/
            emf-worker/target/site/jacoco/
          if-no-files-found: ignore
          retention-days: 7

  # ===========================================================================
  # Test Frontend (lint, typecheck, unit tests with coverage)
  # ===========================================================================
  test-frontend:
    name: Test Frontend
    runs-on: k8s-runner
    defaults:
      run:
        working-directory: emf-web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('emf-web/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm install --no-audit --no-fund
        timeout-minutes: 5

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Format check
        run: npm run format:check

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: emf-web/coverage/
          if-no-files-found: ignore
          retention-days: 7

  # ===========================================================================
  # Quality gate - all checks must pass
  # ===========================================================================
  quality-gate:
    name: Quality Gate
    needs: [test-java, test-frontend]
    if: always()
    runs-on: k8s-runner
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.test-java.result }}" != "success" ]]; then
            echo "Java tests failed"
            exit 1
          fi
          if [[ "${{ needs.test-frontend.result }}" != "success" ]]; then
            echo "Frontend tests failed"
            exit 1
          fi
          echo "All quality gates passed"
