name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Maven projects
        run: |
          echo "Building emf-control-plane..."
          cd emf-control-plane
          mvn clean install -DskipTests
          cd ..
          
          echo "Building emf-gateway..."
          cd emf-gateway
          mvn clean install -DskipTests
          cd ..
          
          echo "Building sample-service..."
          cd sample-service
          mvn clean install -DskipTests
          cd ..
      
      - name: Build Docker images
        run: |
          echo "Building emf-control-plane image..."
          docker build -t emf-control-plane:latest ./emf-control-plane
          
          echo "Building emf-gateway image..."
          docker build -t emf-gateway:latest ./emf-gateway
          
          echo "Building sample-service image..."
          docker build -t sample-service:latest ./sample-service
      
      - name: Start Docker environment
        run: |
          docker-compose up -d
          echo "Docker containers started"
          docker-compose ps
      
      - name: Wait for services to be healthy
        run: |
          chmod +x scripts/wait-for-services.sh
          ./scripts/wait-for-services.sh
      
      - name: Run integration tests
        run: |
          chmod +x scripts/run-integration-tests.sh
          ./scripts/run-integration-tests.sh --ci
      
      - name: Monitor test performance
        if: always()
        run: |
          chmod +x scripts/monitor-test-performance.sh
          ./scripts/monitor-test-performance.sh || true
      
      - name: Upload performance data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-data
          path: .test-performance/
          retention-days: 90
      
      - name: Generate test summary
        if: always()
        run: |
          if [ -d "emf-gateway/target/surefire-reports" ]; then
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count test results
            TOTAL=$(find emf-gateway/target/surefire-reports -name "TEST-*.xml" | wc -l)
            FAILURES=$(grep -r 'failures="' emf-gateway/target/surefire-reports/TEST-*.xml 2>/dev/null | grep -o 'failures="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -r 'errors="' emf-gateway/target/surefire-reports/TEST-*.xml 2>/dev/null | grep -o 'errors="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            TESTS=$(grep -r 'tests="' emf-gateway/target/surefire-reports/TEST-*.xml 2>/dev/null | grep -o 'tests="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            TIME=$(grep -r 'time="' emf-gateway/target/surefire-reports/TEST-*.xml 2>/dev/null | grep -o 'time="[0-9.]*"' | grep -o '[0-9.]*' | awk '{s+=$1} END {print s}')
            
            echo "- **Total Test Classes**: ${TOTAL:-0}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Tests**: ${TESTS:-0}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failures**: ${FAILURES:-0}" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors**: ${ERRORS:-0}" >> $GITHUB_STEP_SUMMARY
            echo "- **Execution Time**: ${TIME:-0}s" >> $GITHUB_STEP_SUMMARY
            
            if [ "${FAILURES:-0}" -eq 0 ] && [ "${ERRORS:-0}" -eq 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "❌ Some tests failed. Check the artifacts for details." >> $GITHUB_STEP_SUMMARY
            fi
            
            # Add performance information
            if [ -f ".test-performance/performance-report.txt" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## Performance Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -20 .test-performance/performance-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No test reports found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Collect service logs
        if: failure()
        run: |
          mkdir -p test-logs
          docker-compose logs --no-color postgres > test-logs/postgres.log 2>&1 || true
          docker-compose logs --no-color redis > test-logs/redis.log 2>&1 || true
          docker-compose logs --no-color kafka > test-logs/kafka.log 2>&1 || true
          docker-compose logs --no-color keycloak > test-logs/keycloak.log 2>&1 || true
          docker-compose logs --no-color emf-control-plane > test-logs/control-plane.log 2>&1 || true
          docker-compose logs --no-color emf-gateway > test-logs/gateway.log 2>&1 || true
          docker-compose logs --no-color sample-service > test-logs/sample-service.log 2>&1 || true
          docker ps -a > test-logs/containers.txt 2>&1 || true
          docker-compose ps > test-logs/compose-status.txt 2>&1 || true
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            emf-gateway/target/surefire-reports/
            emf-gateway/target/site/
            test-reports/
          retention-days: 30
      
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            emf-gateway/target/surefire-reports/TEST-*.xml
          check_name: Integration Test Results
          comment_title: Integration Test Results
          report_individual_runs: true
          deduplicate_classes_by_file_name: false
      
      - name: Upload service logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: test-logs/
          retention-days: 7
      
      - name: Cleanup Docker environment
        if: always()
        run: |
          docker-compose down -v
          docker system prune -f
