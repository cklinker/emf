apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "emf-gateway.fullname" . }}
  labels:
    {{- include "emf-gateway.labels" . | nindent 4 }}
data:
  application.yml: |
    spring:
      application:
        name: emf-gateway
      profiles:
        active: {{ .Values.config.profiles.active }}
      kafka:
        bootstrap-servers: {{ .Values.config.kafka.bootstrapServers }}
        consumer:
          group-id: {{ .Values.config.kafka.consumerGroupId }}
          auto-offset-reset: {{ .Values.config.kafka.autoOffsetReset }}
          enable-auto-commit: {{ .Values.config.kafka.enableAutoCommit }}
      data:
        redis:
          host: {{ .Values.config.redis.host }}
          port: {{ .Values.config.redis.port }}
          database: {{ .Values.config.redis.database }}
          timeout: {{ .Values.config.redis.connectionTimeout }}ms
          lettuce:
            pool:
              min-idle: {{ .Values.config.redis.pool.minIdle }}
              max-idle: {{ .Values.config.redis.pool.maxIdle }}
              max-active: {{ .Values.config.redis.pool.maxActive }}
      security:
        oauth2:
          resourceserver:
            jwt:
              issuer-uri: {{ .Values.config.jwt.issuerUri }}
              {{- if .Values.config.jwt.jwkSetUri }}
              jwk-set-uri: {{ .Values.config.jwt.jwkSetUri }}
              {{- end }}
      cloud:
        gateway:
          httpclient:
            connect-timeout: 5000
            response-timeout: 30s
          globalcors:
            corsConfigurations:
              '[/**]':
                allowedOrigins: "*"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - PATCH
                  - OPTIONS
                allowedHeaders: "*"
                exposedHeaders:
                  - X-RateLimit-Limit
                  - X-RateLimit-Remaining
                  - X-RateLimit-Reset
                  - Retry-After
    
    emf:
      gateway:
        control-plane:
          url: {{ .Values.config.controlPlane.url }}
          bootstrap-path: {{ .Values.config.controlPlane.bootstrapPath }}
          connection-timeout: {{ .Values.config.controlPlane.connectionTimeout }}
          read-timeout: {{ .Values.config.controlPlane.readTimeout }}
        kafka:
          topics:
            collection-changed: {{ .Values.config.kafka.topics.collectionChanged }}
            authz-changed: {{ .Values.config.kafka.topics.authzChanged }}
            service-changed: {{ .Values.config.kafka.topics.serviceChanged }}
        rate-limit:
          enabled: {{ .Values.config.rateLimit.enabled }}
          default:
            requests-per-window: {{ .Values.config.rateLimit.default.requestsPerWindow }}
            window-duration: {{ .Values.config.rateLimit.default.windowDuration }}
    
    management:
      endpoints:
        web:
          exposure:
            include: {{ .Values.config.actuator.exposure.include }}
      endpoint:
        health:
          show-details: {{ .Values.config.actuator.health.showDetails }}
      health:
        livenessState:
          enabled: true
        readinessState:
          enabled: true
    
    logging:
      level:
        root: {{ .Values.config.logging.level.root }}
        com.emf.gateway: {{ .Values.config.logging.level.com.emf.gateway }}
      pattern:
        console: {{ .Values.config.logging.pattern.console | quote }}
