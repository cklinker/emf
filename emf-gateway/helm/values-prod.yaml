# Values for production environment
# Override default values for production Kubernetes cluster

replicaCount: 3

image:
  repository: registry.prod.emf.example.com/emf-gateway
  pullPolicy: IfNotPresent
  tag: ""  # Use chart appVersion or override during deployment

imagePullSecrets:
  - name: registry-credentials

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 1000m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Production environment configuration
config:
  controlPlane:
    url: "http://emf-control-plane.emf-prod.svc.cluster.local:8080"
    bootstrapPath: "/control/bootstrap"
    connectionTimeout: 5000
    readTimeout: 10000

  kafka:
    bootstrapServers: "kafka-0.kafka-headless.kafka-prod.svc.cluster.local:9092,kafka-1.kafka-headless.kafka-prod.svc.cluster.local:9092,kafka-2.kafka-headless.kafka-prod.svc.cluster.local:9092"
    consumerGroupId: "emf-gateway-prod"
    topics:
      collectionChanged: "emf.config.collection.changed"
      authzChanged: "emf.config.authz.changed"
      serviceChanged: "emf.config.service.changed"
    autoOffsetReset: "latest"
    enableAutoCommit: true

  redis:
    host: "redis-master.redis-prod.svc.cluster.local"
    port: 6379
    password: ""  # Must be set via external secret management
    database: 0
    connectionTimeout: 2000
    readTimeout: 1000
    pool:
      minIdle: 10
      maxIdle: 20
      maxActive: 50

  jwt:
    issuerUri: "https://auth.emf.example.com/realms/emf"
    jwkSetUri: "https://auth.emf.example.com/realms/emf/protocol/openid-connect/certs"

  rateLimit:
    default:
      requestsPerWindow: 1000
      windowDuration: "PT1M"
    enabled: true

  cors:
    allowedOriginPatterns:
      - "https://*.emf.example.com"

  logging:
    level:
      root: WARN
      com.emf.gateway: INFO
      org.springframework.cloud.gateway: WARN
      org.springframework.security: WARN
    pattern:
      console: '{"timestamp":"%d{yyyy-MM-dd HH:mm:ss.SSS}","level":"%level","thread":"%thread","logger":"%logger{36}","message":"%msg"}%n'

  actuator:
    exposure:
      include: "health,metrics,prometheus"
    health:
      showDetails: "never"

  profiles:
    active: "prod"

# Production-grade probes
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8080
  initialDelaySeconds: 90
  periodSeconds: 10
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 8080
  initialDelaySeconds: 45
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 30

# Service configuration
service:
  type: ClusterIP
  port: 8080
  targetPort: 8080
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/actuator/prometheus"
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

# Ingress configuration for production
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://*.emf.example.com"
  hosts:
    - host: gateway.emf.example.com
      paths:
        - path: /
          pathType: Prefix
    - host: api.emf.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: gateway-prod-tls
      hosts:
        - gateway.emf.example.com
        - api.emf.example.com

# Strong pod anti-affinity for high availability
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - emf-gateway
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - emf-gateway
          topologyKey: topology.kubernetes.io/zone

# Node selector for production node pool
nodeSelector:
  workload: critical
  environment: production

# Tolerations for production environment
tolerations:
  - key: "workload"
    operator: "Equal"
    value: "critical"
    effect: "NoSchedule"

# Pod annotations for production monitoring
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/actuator/prometheus"
  fluentbit.io/parser: "spring-boot"

# Security context for production
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

# Additional environment variables for production
env:
  - name: SPRING_PROFILES_ACTIVE
    value: "prod"
  - name: JAVA_OPTS
    value: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication -XX:+OptimizeStringConcat"
  - name: MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED
    value: "true"

# Use external secrets for sensitive data
envFrom:
  - secretRef:
      name: emf-gateway-secrets
  - configMapRef:
      name: emf-gateway-prod-config

# Service account with specific permissions
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/emf-gateway-prod"
  name: "emf-gateway-prod"
